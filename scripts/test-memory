#!/bin/bash
# Memory Testing Script for uplink-nodejs
#
# This script runs memory tests on the native C code using Valgrind (Linux)
# or leaks command (macOS).
#
# Usage:
#   ./scripts/test-memory           - Run memory tests
#   ./scripts/test-memory --verbose - Run with verbose output

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}=== Memory Testing for uplink-nodejs ===${NC}\n"

# Detect OS
OS="$(uname -s)"
VERBOSE=""
if [[ "$1" == "--verbose" ]]; then
    VERBOSE="yes"
fi

# Build standalone C test
echo "Building standalone C tests..."
TEST_SRC="$PROJECT_DIR/native/test/test_helpers.c"
TEST_BIN="$PROJECT_DIR/native/test/test_helpers"

if [[ "$OS" == "Darwin" ]]; then
    cc -std=c11 -Wall -Wextra -g -I "$PROJECT_DIR/native/test" "$TEST_SRC" -o "$TEST_BIN"
elif [[ "$OS" == "Linux" ]]; then
    gcc -std=c11 -Wall -Wextra -g -I "$PROJECT_DIR/native/test" "$TEST_SRC" -o "$TEST_BIN"
else
    echo -e "${RED}Unsupported OS: $OS${NC}"
    exit 1
fi

echo -e "${GREEN}Build successful!${NC}\n"

# Run memory analysis
echo "Running memory analysis..."

if [[ "$OS" == "Darwin" ]]; then
    # macOS: Use leaks command
    echo -e "${YELLOW}Using macOS leaks tool...${NC}\n"
    
    # Run the test binary
    "$TEST_BIN"
    
    # Note: leaks command requires the process to be running
    # For a simple test, we just run and check exit code
    echo -e "\n${GREEN}Standalone C tests passed!${NC}"
    echo -e "${YELLOW}Note: For detailed leak analysis on macOS, use:${NC}"
    echo "  MallocStackLogging=1 leaks --atExit -- $TEST_BIN"
    
elif [[ "$OS" == "Linux" ]]; then
    # Linux: Use Valgrind if available
    if command -v valgrind &> /dev/null; then
        echo -e "${YELLOW}Using Valgrind...${NC}\n"
        
        VALGRIND_OPTS="--leak-check=full --show-leak-kinds=all --track-origins=yes"
        VALGRIND_OPTS="$VALGRIND_OPTS --error-exitcode=1"
        
        if [[ "$VERBOSE" == "yes" ]]; then
            VALGRIND_OPTS="$VALGRIND_OPTS --verbose"
        fi
        
        REPORT_FILE="$PROJECT_DIR/valgrind-report.txt"
        
        valgrind $VALGRIND_OPTS --log-file="$REPORT_FILE" "$TEST_BIN"
        
        echo -e "\n${GREEN}Valgrind analysis complete!${NC}"
        echo "Report saved to: $REPORT_FILE"
        
        # Check for leaks in report
        if grep -q "definitely lost: 0 bytes" "$REPORT_FILE" && \
           grep -q "indirectly lost: 0 bytes" "$REPORT_FILE"; then
            echo -e "${GREEN}✓ No memory leaks detected!${NC}"
        else
            echo -e "${RED}⚠ Potential memory leaks detected. Check $REPORT_FILE${NC}"
        fi
    else
        echo -e "${YELLOW}Valgrind not found. Running basic tests...${NC}\n"
        "$TEST_BIN"
        echo -e "\n${GREEN}Standalone C tests passed!${NC}"
        echo -e "${YELLOW}Install Valgrind for detailed memory analysis:${NC}"
        echo "  sudo apt-get install valgrind  # Debian/Ubuntu"
        echo "  sudo yum install valgrind      # CentOS/RHEL"
    fi
fi

# Run Node.js memory tests
echo -e "\n${YELLOW}Running Node.js memory tests...${NC}\n"

cd "$PROJECT_DIR"

# Check if Jest is available
if [[ -f "node_modules/.bin/jest" ]]; then
    # Run memory tests with garbage collection exposed
    node --expose-gc node_modules/.bin/jest test/memory/ --testTimeout=120000 --runInBand 2>&1 || {
        echo -e "${YELLOW}Memory tests require TEST_ACCESS_GRANT to be set${NC}"
        echo "Set TEST_ACCESS_GRANT environment variable to run full memory tests"
    }
else
    echo -e "${YELLOW}Jest not installed. Run 'npm install' first.${NC}"
fi

echo -e "\n${GREEN}=== Memory Testing Complete ===${NC}\n"
