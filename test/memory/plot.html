<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Memory Leak Test Results</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0d1117; color: #c9d1d9; padding: 20px; }
    h1 { text-align: center; margin-bottom: 10px; color: #58a6ff; }
    p.subtitle { text-align: center; margin-bottom: 20px; color: #8b949e; font-size: 14px; }
    .controls { text-align: center; margin-bottom: 20px; }
    .controls input[type="file"] { display: none; }
    .controls label, .controls button {
      display: inline-block; padding: 10px 20px; margin: 5px;
      background: #21262d; border: 1px solid #30363d; border-radius: 6px;
      color: #58a6ff; cursor: pointer; font-size: 14px;
    }
    .controls label:hover, .controls button:hover { background: #30363d; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(600px, 1fr)); gap: 20px; }
    .chart-card {
      background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px;
    }
    .chart-card h3 { margin-bottom: 8px; color: #58a6ff; font-size: 16px; }
    .chart-card .stats { font-size: 12px; color: #8b949e; margin-bottom: 10px; }
    .chart-card canvas { width: 100% !important; height: 300px !important; }
    .summary { margin-top: 20px; background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px; }
    .summary h2 { color: #58a6ff; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #30363d; font-size: 13px; }
    th { color: #8b949e; }
    .pass { color: #3fb950; }
    .fail { color: #f85149; }
  </style>
</head>
<body>
  <h1>üìä Memory Leak Test Results</h1>
  <p class="subtitle">Load CSV files from <code>test/memory/results/</code> to visualize heap usage per function</p>

  <div class="controls">
    <label for="csvFiles">üìÅ Load CSV Files</label>
    <input type="file" id="csvFiles" accept=".csv" multiple />
    <button onclick="loadAllFromDir()">üìÇ Load from results/ (drag &amp; drop also works)</button>
  </div>

  <div class="summary" id="summarySection" style="display:none">
    <h2>Summary</h2>
    <table>
      <thead><tr><th>Function</th><th>Baseline (MB)</th><th>Final (MB)</th><th>Growth (MB)</th><th>Status</th></tr></thead>
      <tbody id="summaryBody"></tbody>
    </table>
  </div>

  <div class="grid" id="chartsGrid"></div>

  <script>
    const ALLOWED_GROWTH_MB = 5;
    const charts = {};
    const allResults = [];

    // Drag & drop support
    document.body.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); });
    document.body.addEventListener('drop', (e) => {
      e.preventDefault(); e.stopPropagation();
      handleFiles(e.dataTransfer.files);
    });

    document.getElementById('csvFiles').addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    function loadAllFromDir() {
      alert('Please select all CSV files from test/memory/results/ using the file picker.\n\nTip: Cmd+A (Mac) or Ctrl+A (Win) to select all files at once.');
      document.getElementById('csvFiles').click();
    }

    function handleFiles(files) {
      for (const file of files) {
        if (file.name.endsWith('.csv')) {
          const reader = new FileReader();
          reader.onload = (e) => parseAndPlot(file.name, e.target.result);
          reader.readAsText(file);
        }
      }
    }

    function parseAndPlot(filename, csvText) {
      const lines = csvText.trim().split('\n');
      const header = lines[0];
      const data = lines.slice(1).map((line) => {
        const [iteration, heapUsedMB, growthFromBaselineMB] = line.split(',').map(Number);
        return { iteration, heapUsedMB, growthFromBaselineMB };
      });

      const funcName = filename.replace('.csv', '').replace(/_/g, '.');
      const baseline = data[0].heapUsedMB;
      const final = data[data.length - 1].heapUsedMB;
      const growth = final - baseline;

      allResults.push({ funcName, baseline, final, growth });
      updateSummary();
      createChart(funcName, data, baseline);
    }

    function updateSummary() {
      const section = document.getElementById('summarySection');
      const body = document.getElementById('summaryBody');
      section.style.display = 'block';
      body.innerHTML = allResults
        .sort((a, b) => b.growth - a.growth)
        .map((r) => {
          const status = r.growth < ALLOWED_GROWTH_MB ? 'pass' : 'fail';
          const icon = status === 'pass' ? '‚úÖ' : '‚ùå';
          return `<tr>
            <td>${r.funcName}</td>
            <td>${r.baseline.toFixed(2)}</td>
            <td>${r.final.toFixed(2)}</td>
            <td class="${status}">${r.growth.toFixed(4)}</td>
            <td class="${status}">${icon} ${status === 'pass' ? 'PASS' : 'FAIL'}</td>
          </tr>`;
        }).join('');
    }

    function createChart(funcName, data, baseline) {
      const grid = document.getElementById('chartsGrid');

      // Remove existing card if re-loading
      const existingId = `card-${funcName}`;
      const existing = document.getElementById(existingId);
      if (existing) existing.remove();

      const card = document.createElement('div');
      card.className = 'chart-card';
      card.id = existingId;

      const growth = data[data.length - 1].heapUsedMB - baseline;
      const maxGrowth = Math.max(...data.map((d) => d.growthFromBaselineMB));

      card.innerHTML = `
        <h3>${funcName}</h3>
        <div class="stats">
          Baseline: ${baseline.toFixed(2)} MB | Growth: ${growth.toFixed(4)} MB | Peak delta: ${maxGrowth.toFixed(4)} MB
        </div>
        <canvas id="chart-${funcName}"></canvas>
      `;
      grid.appendChild(card);

      const ctx = card.querySelector('canvas').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map((d) => d.iteration),
          datasets: [
            {
              label: 'Heap Used (MB)',
              data: data.map((d) => d.heapUsedMB),
              borderColor: '#58a6ff',
              backgroundColor: 'rgba(88, 166, 255, 0.1)',
              fill: true,
              pointRadius: 0,
              borderWidth: 2,
              tension: 0.3,
            },
            {
              label: 'Baseline',
              data: data.map(() => baseline),
              borderColor: '#3fb950',
              borderDash: [5, 5],
              pointRadius: 0,
              borderWidth: 1,
              fill: false,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#8b949e', font: { size: 11 } } },
          },
          scales: {
            x: {
              title: { display: true, text: 'Iteration', color: '#8b949e' },
              ticks: { color: '#8b949e', maxTicksLimit: 10 },
              grid: { color: '#21262d' },
            },
            y: {
              title: { display: true, text: 'Heap Used (MB)', color: '#8b949e' },
              ticks: { color: '#8b949e' },
              grid: { color: '#21262d' },
            },
          },
        },
      });
    }
  </script>
</body>
</html>
