# ==============================================================================
# Release Pipeline - GitHub Release Only (no npm publish)
# ==============================================================================
# Triggers: Tags (v*), manual dispatch
# Purpose: Build, test, and create GitHub releases with prebuilt binaries
#
# NOTE: npm publishing is NOT done here for security reasons. Publish manually
#       with `npm publish` after verifying the GitHub release.
# ==============================================================================

name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
      dry_run:
        description: 'Dry run (no actual release)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  GO_VERSION: '1.21'

jobs:
  # ============================================================================
  # Validate Release
  # ============================================================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "## Release Info" >> $GITHUB_STEP_SUMMARY
          echo "- Version: $VERSION" >> $GITHUB_STEP_SUMMARY

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "Invalid version format: $VERSION"
            exit 1
          fi

  # ============================================================================
  # Security Check
  # ============================================================================
  security:
    name: Security Check
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: npm audit
        run: npm audit --audit-level=critical

      - name: Gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Build All Platforms
  # ============================================================================
  build:
    name: Build (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    needs: [validate, security]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
            arch: x64
          # - os: ubuntu-24.04-arm64
          #   platform: linux-arm64
          #   arch: arm64
          - os: macos-15
            platform: darwin-x64
            arch: x64
          - os: macos-15
            platform: darwin-arm64
            arch: arm64
          - os: windows-latest
            platform: win32-x64
            arch: x64

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Python (Windows)
        if: runner.os == 'Windows'
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.11'

      - name: Install MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@0b201ec74fa43914dc39ae48a89fd1d8cb592756 # v1

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Build from source
        run: make install-source VERBOSE=1 PLATFORM=${{ matrix.platform }}
        shell: bash
        env:
          npm_config_arch: ${{ matrix.arch }}

      - name: Run tests
        if: matrix.arch == 'arm64' || runner.arch == 'X64'
        run: npm run test:unit

      - name: Verify build outputs
        run: |
          echo "=== native/prebuilds/${{ matrix.platform }} ==="
          ls -lh "native/prebuilds/${{ matrix.platform }}/" || echo "ERROR: prebuilds dir missing!"
          echo "=== native/include ==="
          ls -lh native/include/ || echo "ERROR: include dir missing!"
        shell: bash

      - name: Create archive
        # Archive layout:
        #   libuplink.{dylib,so,dll}   — shared library
        #   uplink_native.node          — pre-compiled Node addon
        #   uplink.{def,lib,exp}        — Windows import lib (win32 only)
        #   include/uplink.h            — main API header
        #   include/uplink_definitions.h
        #   include/uplink_compat.h
        #
        # The include/ subdirectory is extracted by `make download-addon` into
        # native/include/ so that the hybrid fallback (node-gyp rebuild) can find
        # the headers without a separate download step.
        run: |
          set -euo pipefail
          PLATFORM="${{ matrix.platform }}"
          VERSION="${{ needs.validate.outputs.version }}"
          ARCHIVE="uplink-nodejs-v${VERSION}-${PLATFORM}.tar.gz"
          PREBUILD_DIR="native/prebuilds/${PLATFORM}"
          INCLUDE_DIR="native/include"

          # Verify inputs exist
          if [ ! -d "${PREBUILD_DIR}" ]; then
            echo "ERROR: prebuilds dir not found: ${PREBUILD_DIR}"
            exit 1
          fi
          if [ ! -f "${INCLUDE_DIR}/uplink.h" ]; then
            echo "ERROR: headers not found in ${INCLUDE_DIR}/"
            echo "Contents of native/include/:"
            ls -la native/include/ 2>/dev/null || echo "(directory missing)"
            exit 1
          fi

          # Stage a temp dir with the desired archive layout
          STAGE=$(mktemp -d)

          # Copy binaries (exclude any subdirectories like 'include' if present)
          find "${PREBUILD_DIR}" -maxdepth 1 -type f -exec cp {} "${STAGE}/" \;

          # Copy headers into include/ subdirectory
          mkdir -p "${STAGE}/include"
          cp "${INCLUDE_DIR}/uplink.h" \
             "${INCLUDE_DIR}/uplink_definitions.h" \
             "${INCLUDE_DIR}/uplink_compat.h" \
             "${STAGE}/include/"

          tar -czvf "${ARCHIVE}" -C "${STAGE}" .
          echo ""
          echo "=== Archive contents ==="
          tar -tzvf "${ARCHIVE}"
        shell: bash

      - name: Upload prebuilt artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: prebuild-${{ matrix.platform }}
          path: uplink-nodejs-*.tar.gz

  # ============================================================================
  # Create GitHub Release
  # ============================================================================
  github-release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, build]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Download all artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Generate changelog
        id: changelog
        run: |
          echo "## What's Changed" > CHANGELOG_RELEASE.md
          echo "" >> CHANGELOG_RELEASE.md
          git log --pretty=format:"- %s (%h)" $(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo HEAD~10)..HEAD >> CHANGELOG_RELEASE.md || true
          echo "" >> CHANGELOG_RELEASE.md
          echo "" >> CHANGELOG_RELEASE.md
          echo "## Installation" >> CHANGELOG_RELEASE.md
          echo "" >> CHANGELOG_RELEASE.md
          echo '```bash' >> CHANGELOG_RELEASE.md
          echo 'npm install storj-uplink-nodejs@${{ needs.validate.outputs.version }}' >> CHANGELOG_RELEASE.md
          echo '```' >> CHANGELOG_RELEASE.md
          echo "" >> CHANGELOG_RELEASE.md
          echo "## Prebuilt Binaries" >> CHANGELOG_RELEASE.md
          echo "" >> CHANGELOG_RELEASE.md
          echo "| Platform | File |" >> CHANGELOG_RELEASE.md
          echo "|----------|------|" >> CHANGELOG_RELEASE.md
          for f in artifacts/*.tar.gz; do
            name=$(basename "$f")
            echo "| ${name%%.tar.gz} | $name |" >> CHANGELOG_RELEASE.md
          done

      - name: Create Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        if: ${{ github.event.inputs.dry_run != 'true' }}
        with:
          tag_name: v${{ needs.validate.outputs.version }}
          name: Release v${{ needs.validate.outputs.version }}
          body_path: CHANGELOG_RELEASE.md
          files: artifacts/*.tar.gz
          draft: false
          prerelease: ${{ contains(needs.validate.outputs.version, '-') }}
          generate_release_notes: true

      - name: Dry run summary
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "## Dry Run - Would create release:" >> $GITHUB_STEP_SUMMARY
          echo "- Tag: v${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Files:" >> $GITHUB_STEP_SUMMARY
          ls -la artifacts/*.tar.gz >> $GITHUB_STEP_SUMMARY

