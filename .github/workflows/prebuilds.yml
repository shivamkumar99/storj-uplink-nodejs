# ==============================================================================
# Build Prebuilds - Cross-Platform Binary Building
# ==============================================================================
# Triggers: Tags (v*), manual dispatch
# Purpose: Build prebuilt binaries for all platforms
# ==============================================================================

name: Build Prebuilds

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      uplink_c_version:
        description: 'uplink-c version to build'
        required: false
        default: 'v1.14.0'

env:
  UPLINK_C_VERSION: ${{ github.event.inputs.uplink_c_version || 'v1.14.0' }}

jobs:
  # ============================================================================
  # Build Matrix - All Platforms
  # ============================================================================
  build:
    name: Build (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
            arch: x64
          # - os: ubuntu-24.04-arm64
          #   platform: linux-arm64
          #   arch: arm64
          - os: macos-15
            platform: darwin-x64
            arch: x64
          - os: macos-15
            platform: darwin-arm64
            arch: arm64
          - os: windows-latest
            platform: win32-x64
            arch: x64

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version: '1.21'

      - name: Setup Python (Windows)
        if: runner.os == 'Windows'
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.11'

      - name: Install MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@0b201ec74fa43914dc39ae48a89fd1d8cb592756 # v1

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Build from source
        run: make install-source VERBOSE=1 UPLINK_C_VERSION=${{ env.UPLINK_C_VERSION }} PLATFORM=${{ matrix.platform }}
        shell: bash
        env:
          npm_config_arch: ${{ matrix.arch }}

      - name: Verify build
        run: make verify-full PLATFORM=${{ matrix.platform }}
        shell: bash

      - name: Run tests
        if: matrix.arch == 'arm64' || runner.arch == 'X64'
        run: npm run test:unit
        continue-on-error: true

      - name: Create archive
        run: |
          cd native/prebuilds/${{ matrix.platform }}
          tar -czvf ../../../uplink-nodejs-${{ github.ref_name || 'dev' }}-${{ matrix.platform }}.tar.gz *
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: prebuild-${{ matrix.platform }}
          path: uplink-nodejs-*.tar.gz
          retention-days: 30

  # ============================================================================
  # Verify All Builds
  # ============================================================================
  verify:
    name: Verify Builds
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: |
          echo "## Built Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          for f in artifacts/*.tar.gz; do
            size=$(ls -lh "$f" | awk '{print $5}')
            name=$(basename "$f")
            echo "| $name | $size |" >> $GITHUB_STEP_SUMMARY
          done

      - name: Upload combined artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: all-prebuilds
          path: artifacts/*.tar.gz
          retention-days: 90
